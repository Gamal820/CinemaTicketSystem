@using Microsoft.AspNetCore.Identity
@using CinemaTicketSystem.Models
@model CinemaTicketSystem.ViewModels.ManageUsersVM

@inject UserManager<ApplicationUser> UserManager

<div class="container mt-4">
    <h2 class="mb-3 text-center fw-bold text-primary">All Users</h2>
    <table class="table table-striped table-bordered align-middle text-center shadow">
        <thead class="table-dark">
            <tr>
                <th>#</th>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var user in Model.Users)
            {
                var roles = await UserManager.GetRolesAsync(user);
                <tr>
                    <td>@user.Id</td>
                    <td>@user.FirstName @user.LastName</td>
                    <td>@user.Email</td>
                    <td>
                        @if (roles.Any())
                        {
                            foreach (var role in roles)
                            {
                                <span class="badge bg-info text-dark">@role</span>
                            }
                        }
                        else
                        {
                            <span class="text-muted">No Role</span>
                        }
                    </td>
                    <td>
                        @if (user.LockoutEnd != null && user.LockoutEnd > DateTime.UtcNow)
                        {
                            <span class="badge bg-danger">Locked</span>
                        }
                        else
                        {
                            <span class="badge bg-success">Active</span>
                        }
                    </td>
                    <td>
                        <a href="/Admin/User/ManageRole/@user.Id" class="btn btn-sm btn-warning">Manage Role</a>
                        <a href="/Admin/User/LockUnLock/@user.Id" class="btn btn-sm @(user.LockoutEnd != null && user.LockoutEnd > DateTime.UtcNow ? "btn-success" : "btn-danger")">
                            @(user.LockoutEnd != null && user.LockoutEnd > DateTime.UtcNow ? "UnLock" : "Lock")
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>


@section Scripts {
    <partial name="_NotificationPartial" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const lockButtons = document.querySelectorAll(".lock-btn");

            lockButtons.forEach(button => {
                button.addEventListener("click", function (e) {
                    e.preventDefault();
                    const url = this.getAttribute("href");

                    Swal.fire({
                        title: "Are you sure?",
                        text: "This action cannot be undone!",
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#d33",
                        cancelButtonColor: "#3085d6",
                        confirmButtonText: "Yes, continue"
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = url;
                        }
                    });
                });
            });
        });
    </script>
}
